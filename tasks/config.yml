---

- set_fact:
    name: automysqlbackup
    conf:
      file: /etc/default/automysqlbackup
      vars:
        backupdir:
          old: BACKUPDIR="/var/lib/automysqlbackup"
          new: |-
            {{ 'BACKUPDIR="' + backupdir + '"' }}
        latest:
          old: LATEST=no
          new: LATEST=yes
        mailcontent:
          old: MAILCONTENT="quiet"
          new: MAILCONTENT="log"


- hg_commit: { cwd: /etc, com: 'Before configuring {{ name }}', user: '{{ user_email }}' }


- name: Conf comment out orig value loop
  with_dict: '{{ conf.vars }}'

  replace:
    dest: '{{ conf.file }}'
    regexp: |-
      {{ "^" + item.value.old + "$" }}
    replace: '#\g<0>'


- name: Conf setup new value loop
  with_dict: '{{ conf.vars }}'

  lineinfile:
    dest: '{{ conf.file }}'
    line: '{{ item.value.new }}'
    insertafter: |-
      {{ "^#" + item.value.old + "$" }}


- hg_commit: { cwd: /etc, com: 'After configuring {{ name }}', user: '{{ user_email }}' }
